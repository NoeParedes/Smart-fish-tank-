{% extends "base2.html" %}

{% block title %}Peceras - AquaZen{% endblock %}

{% block content %}

    <style>
    .custom-switch {
        width: 60px;
        height: 25px;
        background-color: #ef4444;
        border-radius: 30px;
        position: relative;
        appearance: none;
        cursor: pointer;
        outline: none;
        transition: background-color 0.3s ease-in-out;
    }

    .custom-switch:checked {
        background-color: #06b6d4;
    }

    .custom-switch::before {
        content: '';
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
        position: absolute;
        top: 2.5px;
        left: 2.5px;
        transition: transform 0.3s ease-in-out;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .custom-switch:checked::before {
        transform: translateX(35px);
    }

    .pecera-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 2px solid rgba(6, 182, 212, 0.2);
        border-radius: 15px;
        background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 50%, #a7f3d0 100%);
    }

    .pecera-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
    }

    .command-card {
        border: none;
        border-radius: 18px;
        background: white;
        box-shadow: 0 15px 45px rgba(6, 182, 212, 0.15);
        height: 100%;
    }

    .command-pill {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        background: rgba(6, 182, 212, 0.12);
        color: #0f172a;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .command-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(6, 182, 212, 0.25);
    }

    .command-pill-danger {
        background: rgba(248, 113, 113, 0.18);
        color: #b91c1c;
    }

    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-chip.idle {
        background: #f1f5f9;
        color: #475569;
    }

    .status-chip.sending {
        background: #fef9c3;
        color: #854d0e;
    }

    .status-chip.success {
        background: #dcfce7;
        color: #166534;
    }

    .status-chip.error {
        background: #fee2e2;
        color: #991b1b;
    }

    .exceptional-form label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #0f172a;
    }

    .exceptional-form input,
    .exceptional-form select {
        border-radius: 12px;
        border: 1px solid #bae6fd;
    }

    .sensor-card {
        background: linear-gradient(160deg, #0ea5e9 0%, #06b6d4 60%, #22d3ee 100%);
        color: white;
        border-radius: 18px;
        box-shadow: 0 12px 35px rgba(14, 165, 233, 0.25);
    }

    .sensor-card h5 {
        font-weight: 600;
    }

    .sensor-metric {
        font-size: 2rem;
        font-weight: 700;
    }

    .chart-wrapper {
        background: rgba(255,255,255,0.15);
        border-radius: 18px;
        padding: 1rem;
    }

    .history-timeline {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .history-timeline li {
        font-size: 0.85rem;
        margin-bottom: 0.35rem;
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
    }

    .history-timeline span {
        color: #0f172a;
        font-weight: 600;
    }
    </style>

    <div id="commandToastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

                <div class="container mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h2 text-cyan-800 mb-1">
                                <svg class="w-8 h-8 me-2 d-inline" fill="currentColor" viewBox="0 0 24 24" width="32" height="32">
                                    <path d="M12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5M12,2A7,7 0 0,1 19,9C19,14.25 12,22 12,22C12,22 5,14.25 5,9A7,7 0 0,1 12,2Z"/>
                                </svg>
                                Sistema de Peceras Inteligentes
                            </h1>
                            <p class="text-cyan-600">Monitoreo y control automático de ecosistemas acuáticos</p>
                        </div>
                        <div>
                            <button class="btn btn-gradient me-2" data-bs-toggle="modal" data-bs-target="#registrarAspersorModal" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; border: none;">
                                <i class="fas fa-plus me-1"></i>Nueva Pecera
                            </button>
                            <button class="btn btn-outline-cyan" id="openCommandCenter" data-bs-toggle="modal" data-bs-target="#commandCenterModal" style="border-color: #06b6d4; color: #06b6d4;">
                                <i class="fas fa-sliders-h me-1"></i>Centro de Control
                            </button>
                        </div>
                    </div>
            
                    <!-- Mostrar las peceras -->
                    <div class="row">
                        {% for aspersor in aspersores %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card pecera-card h-100 shadow-lg">
                                <div class="card-header text-center" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none;">
                                    <h6 class="mb-0 fw-bold">{{ aspersor.nombre }}</h6>
                                </div>
                                <!-- SVG de pecera en lugar de imagen -->
                                <div class="d-flex justify-center py-4">
                                    <svg class="mx-auto" width="150" height="120" viewBox="0 0 200 150" fill="none">
                                        <!-- Pecera -->
                                        <rect x="20" y="40" width="160" height="90" rx="10" fill="rgba(6, 182, 212, 0.2)" stroke="#0891b2" stroke-width="2"/>
                                        <!-- Agua -->
                                        <rect x="25" y="45" width="150" height="80" rx="8" fill="rgba(6, 182, 212, 0.4)"/>
                                        <!-- Peces -->
                                        <ellipse cx="70" cy="75" rx="8" ry="5" fill="#f59e0b" opacity="0.9"/>
                                        <ellipse cx="130" cy="65" rx="6" ry="4" fill="#ef4444" opacity="0.9"/>
                                        <ellipse cx="110" cy="95" rx="10" ry="6" fill="#10b981" opacity="0.9"/>
                                        <!-- Burbujas -->
                                        <circle cx="60" cy="110" r="2" fill="white" opacity="0.7"/>
                                        <circle cx="150" cy="100" r="1.5" fill="white" opacity="0.6"/>
                                        <circle cx="90" cy="120" r="2.5" fill="white" opacity="0.8"/>
                                        <!-- Plantas -->
                                        <path d="M40 125 Q45 110 50 125" stroke="#10b981" stroke-width="1.5" fill="none"/>
                                        <path d="M160 120 Q165 105 170 120" stroke="#10b981" stroke-width="1.5" fill="none"/>
                                    </svg>
                                </div>
                                <div class="card-body text-center">
                                    <p class="text-cyan-700 mb-2"><i class="fas fa-map-marker-alt me-1"></i><strong>Ubicación:</strong> {{ aspersor.ubicacion }}</p>
                                    {% if mostrar_todos %}
                                    <p class="text-muted small mb-3">
                                        <i class="fas fa-user me-1"></i>Propietario: {{ aspersor.nombre_usuario or 'Desconocido' }} (ID: {{ aspersor.id_usuario }})
                                    </p>
                                    {% endif %}
                                    <div class="position-absolute top-0 end-0 p-3">
                                        <div class="form-check form-switch">
                                            <input 
                                                class="form-check-input estado-switch custom-switch" 
                                                type="checkbox" 
                                                role="switch" 
                                                id="estadoSwitch{{ aspersor.id_aspersor }}" 
                                                {% if aspersor.estado == 'activo' %} checked {% endif %} 
                                                data-id="{{ aspersor.id_aspersor }}">
                                        </div>
                                    </div>                                    
                                    <div class="d-flex justify-content-center mt-3 gap-2">
                                        <button class="btn btn-warning btn-sm editar-aspersor" data-id="{{aspersor.id_aspersor}}" data-nombre="{{aspersor.nombre}}" data-ubicacion="{{aspersor.ubicacion}}" data-camera-url="{{aspersor.camera_url or ''}}" data-bs-toggle="modal" data-bs-target="#editarAspersorModal" title="Editar Pecera">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="window.location.href='/calendar/{{ aspersor.id_aspersor}}'" title="Planificador de Alimentación">
                                            <i class="fas fa-bowl-food"></i>
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="window.location.href='/camara/{{ aspersor.id_aspersor}}'" title="Ver Cámara en Vivo">
                                            <i class="fas fa-video"></i>
                                        </button>
                                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#commandCenterModal" title="Centro de Control">
                                            <i class="fas fa-sliders-h"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm eliminar-aspersor" data-id="{{aspersor.id_aspersor}}" title="Eliminar Pecera">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% endfor %}
                    </div>
                </div>
            
                <!-- Modal para editar pecera -->
                <div class="modal fade" id="editarAspersorModal" tabindex="-1" aria-labelledby="editarAspersorModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(8, 145, 178, 0.3);">
                            <div class="modal-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 50%, #67e8f9 100%); color: white; border: none;">
                                <h5 class="modal-title fw-bold" id="editarAspersorModalLabel">
                                    <i class="fas fa-fish me-2"></i>Editar Configuración de Pecera
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="POST" action="/actualizar_aspersor">
                                <div class="modal-body" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); padding: 2rem;">
                                    <input type="hidden" id="editarIdAspersor" name="id_aspersor">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="editarNombre" class="form-label fw-bold text-teal-800">
                                                    <i class="fas fa-tag me-2 text-teal-600"></i>Nombre de la Pecera
                                                </label>
                                                <input type="text" class="form-control" id="editarNombre" name="nombre" required 
                                                       style="border: 2px solid #67e8f9; border-radius: 10px; padding: 12px; transition: all 0.3s ease;"
                                                       onfocus="this.style.borderColor='#0891b2'; this.style.boxShadow='0 0 0 0.2rem rgba(8, 145, 178, 0.25)'"
                                                       onblur="this.style.borderColor='#67e8f9'; this.style.boxShadow='none'">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="editarUbicacion" class="form-label fw-bold text-teal-800">
                                                    <i class="fas fa-map-marker-alt me-2 text-teal-600"></i>Ubicación
                                                </label>
                                                <input type="text" class="form-control" id="editarUbicacion" name="ubicacion" required
                                                       style="border: 2px solid #67e8f9; border-radius: 10px; padding: 12px; transition: all 0.3s ease;"
                                                       onfocus="this.style.borderColor='#0891b2'; this.style.boxShadow='0 0 0 0.2rem rgba(8, 145, 178, 0.25)'"
                                                       onblur="this.style.borderColor='#67e8f9'; this.style.boxShadow='none'">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="editarCameraUrl" class="form-label fw-bold text-teal-800">
                                            <i class="fas fa-video me-2 text-teal-600"></i>URL de Cámara Submarina (Opcional)
                                        </label>
                                        <input type="text" class="form-control" id="editarCameraUrl" name="camera_url" 
                                               placeholder="Ej: http://192.168.18.123:81/stream"
                                               style="border: 2px solid #67e8f9; border-radius: 10px; padding: 12px; transition: all 0.3s ease;"
                                               onfocus="this.style.borderColor='#0891b2'; this.style.boxShadow='0 0 0 0.2rem rgba(8, 145, 178, 0.25)'"
                                               onblur="this.style.borderColor='#67e8f9'; this.style.boxShadow='none'">
                                        <small class="form-text text-teal-700 mt-2 d-block">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Introduce la URL de streaming de tu cámara ESP32 para monitoreo en vivo
                                        </small>
                                    </div>
                                </div>
                                <div class="modal-footer" style="background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); border: none; padding: 1.5rem;">
                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal" 
                                            style="border: 2px solid #94a3b8; color: #64748b; padding: 10px 20px; border-radius: 10px; font-weight: 600;">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </button>
                                    <button type="submit" class="btn" 
                                            style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; padding: 10px 25px; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 15px rgba(8, 145, 178, 0.3);">
                                        <i class="fas fa-save me-2"></i>Guardar Cambios
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Modal para registrar nueva pecera -->
                <div class="modal fade" id="registrarAspersorModal" tabindex="-1" aria-labelledby="registrarAspersorModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(14, 116, 144, 0.4);">
                            <div class="modal-header" style="background: linear-gradient(135deg, #0e7490 0%, #0891b2 50%, #06b6d4 100%); color: white; border: none; padding: 2rem;">
                                <h5 class="modal-title fw-bold fs-4" id="registrarAspersorModalLabel">
                                    <svg class="me-3" width="32" height="32" viewBox="0 0 100 80" fill="none">
                                        <rect x="10" y="20" width="80" height="45" rx="8" fill="rgba(255, 255, 255, 0.2)" stroke="white" stroke-width="2"/>
                                        <rect x="13" y="23" width="74" height="39" rx="6" fill="rgba(255, 255, 255, 0.1)"/>
                                        <ellipse cx="35" cy="40" rx="6" ry="4" fill="#fbbf24" opacity="0.9"/>
                                        <ellipse cx="65" cy="35" rx="4" ry="3" fill="#ef4444" opacity="0.9"/>
                                        <circle cx="25" cy="55" r="1.5" fill="white" opacity="0.8"/>
                                        <circle cx="75" cy="50" r="1" fill="white" opacity="0.6"/>
                                        <path d="M20 60 Q22 50 24 60" stroke="#10b981" stroke-width="1" fill="none"/>
                                        <path d="M76 58 Q78 48 80 58" stroke="#10b981" stroke-width="1" fill="none"/>
                                    </svg>
                                    Configurar Nueva Pecera Inteligente
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            {% if mostrar_todos %}
                            <form method="POST" action="{{ url_for('crear_aspersor', id_usuario=session['id_usuario']) }}">
                            {% else %}
                            <form method="POST" action="{{ url_for('crear_aspersor', id_usuario=id_usuario_visto) }}">
                            {% endif %}
                                <div class="modal-body" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 50%, #a7f3d0 100%); padding: 2.5rem;">
                                    <div class="text-center mb-4">
                                        <div class="d-inline-flex align-items-center justify-content-center" 
                                             style="width: 80px; height: 80px; background: linear-gradient(135deg, #0891b2, #06b6d4); border-radius: 50%; margin-bottom: 1rem;">
                                            <i class="fas fa-fish text-white" style="font-size: 2rem;"></i>
                                        </div>
                                        <p class="text-teal-700 fs-6">Complete la información para registrar un nuevo sistema de monitoreo acuático</p>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="nombre" class="form-label fw-bold text-teal-800">
                                                    <i class="fas fa-tag me-2 text-teal-600"></i>Identificador de Pecera
                                                </label>
                                                <input type="text" class="form-control" id="nombre" name="nombre" required 
                                                       placeholder="Ej: Pecera Principal A1"
                                                       style="border: 2px solid #67e8f9; border-radius: 12px; padding: 14px; font-size: 1rem; transition: all 0.3s ease;"
                                                       onfocus="this.style.borderColor='#0891b2'; this.style.boxShadow='0 0 0 0.2rem rgba(8, 145, 178, 0.25)'"
                                                       onblur="this.style.borderColor='#67e8f9'; this.style.boxShadow='none'">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="ubicacion" class="form-label fw-bold text-teal-800">
                                                    <i class="fas fa-map-marker-alt me-2 text-teal-600"></i>Ubicación Física
                                                </label>
                                                <input type="text" class="form-control" id="ubicacion" name="ubicacion" required 
                                                       placeholder="Ej: Laboratorio - Sección B"
                                                       style="border: 2px solid #67e8f9; border-radius: 12px; padding: 14px; font-size: 1rem; transition: all 0.3s ease;"
                                                       onfocus="this.style.borderColor='#0891b2'; this.style.boxShadow='0 0 0 0.2rem rgba(8, 145, 178, 0.25)'"
                                                       onblur="this.style.borderColor='#67e8f9'; this.style.boxShadow='none'">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="camera_url" class="form-label fw-bold text-teal-800">
                                            <i class="fas fa-video me-2 text-teal-600"></i>Sistema de Visión Submarina
                                        </label>
                                        <div class="input-group" style="border-radius: 12px; overflow: hidden;">
                                            <span class="input-group-text" style="background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; border: none;">
                                                <i class="fas fa-camera"></i>
                                            </span>
                                            <input type="text" class="form-control" id="camera_url" name="camera_url" 
                                                   value="{{ camera_default_url }}" 
                                                   placeholder="{{ camera_default_url }}"
                                                   style="border: 2px solid #67e8f9; border-left: none; padding: 14px; font-size: 1rem; transition: all 0.3s ease;"
                                                   onfocus="this.style.borderColor='#0891b2'; this.style.boxShadow='0 0 0 0.2rem rgba(8, 145, 178, 0.25)'"
                                                   onblur="this.style.borderColor='#67e8f9'; this.style.boxShadow='none'">
                                        </div>
                                        <small class="form-text text-teal-700 mt-2 d-block">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Configure la URL del stream de video para monitoreo visual en tiempo real
                                        </small>
                                    </div>
                                    
                                    <div class="alert" style="background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); border: 2px solid #67e8f9; border-radius: 12px;">
                                        <h6 class="text-teal-800 mb-2">
                                            <i class="fas fa-lightbulb me-2 text-yellow-500"></i>Características del Sistema
                                        </h6>
                                        <ul class="text-teal-700 mb-0 small">
                                            <li>Monitoreo automático de temperatura y pH</li>
                                            <li>Detección de nivel de agua por ultrasonido</li>
                                            <li>Vigilancia visual con cámara submarina</li>
                                            <li>Alertas inteligentes y control remoto</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="modal-footer" style="background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); border: none; padding: 2rem;">
                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal" 
                                            style="border: 2px solid #94a3b8; color: #64748b; padding: 12px 24px; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;"
                                            onmouseover="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#64748b'"
                                            onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#94a3b8'">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </button>
                                    <button type="submit" class="btn" 
                                            style="background: linear-gradient(135deg, #0e7490 0%, #0891b2 50%, #06b6d4 100%); color: white; border: none; padding: 12px 30px; border-radius: 12px; font-weight: 600; box-shadow: 0 6px 20px rgba(14, 116, 144, 0.4); transition: all 0.3s ease;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(14, 116, 144, 0.5)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(14, 116, 144, 0.4)'">
                                        <i class="fas fa-plus me-2"></i>Crear Pecera Inteligente
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
            
            {% set command_labels = {
                'AUTOMATICO': 'Automático',
                'VACIAR': 'Vaciar',
                'RELLENAR': 'Rellenar',
                'REINICIAR': 'Reiniciar',
                'CANCELAR': 'Cancelar',
                'EXCEPCIONAL': 'Excepcional'
            } %}

            <div class="modal fade" id="commandCenterModal" tabindex="-1" aria-labelledby="commandCenterModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white;">
                            <h5 class="modal-title" id="commandCenterModalLabel">
                                <i class="fas fa-sliders-h me-2"></i>Centro de Control AquaZen
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="aquazenCommandCenter">
                            <div class="mb-3 text-muted">
                                Broker {{ mqtt_broker }} · Tópico {{ mqtt_topic_catcher }}
                            </div>
                            <div class="row g-4">
                                <div class="col-lg-7">
                                    <div class="card command-card">
                                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="mb-0 text-cyan-800 fw-bold">Acciones principales</h5>
                                                <small class="text-muted">Selecciona un modo o envía una prueba manual</small>
                                            </div>
                                            <span id="commandStatusBadge" class="status-chip idle">
                                                <i class="fas fa-circle"></i>Sin comandos
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-recycle text-cyan-600 me-2"></i>
                                                    <h6 class="mb-0 text-cyan-800">Modos Principales</h6>
                                                </div>
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% for mode in catcher_primary_modes %}
                                                    <button type="button" class="command-pill" data-command="{{ mode }}">
                                                        {{ command_labels[mode] }}
                                                    </button>
                                                    {% endfor %}
                                                </div>
                                                <div class="mt-3">
                                                    <label for="targetLevelInput" class="form-label text-uppercase small fw-bold text-cyan-900">Nivel objetivo (cm) para Rellenar</label>
                                                    <input type="number" min="1" step="1" class="form-control" id="targetLevelInput" placeholder="Ej: 35">
                                                    <small class="text-muted">Este valor solo se enviará cuando presiones "Rellenar".</small>
                                                </div>
                                            </div>

                                            <hr>

                                            <div class="mb-3">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-shield-halved text-danger me-2"></i>
                                                    <h6 class="mb-0 text-cyan-800">Parada y Emergencia</h6>
                                                </div>
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% for mode in catcher_safety_commands %}
                                                    <button type="button" class="command-pill command-pill-danger" data-command="{{ mode }}">
                                                        {{ command_labels[mode] }}
                                                    </button>
                                                    {% endfor %}
                                                </div>
                                            </div>

                                            <div class="mt-4">
                                                <div class="d-flex align-items-center mb-3">
                                                    <i class="fas fa-flask text-cyan-600 me-2"></i>
                                                    <h6 class="mb-0 text-cyan-800">Modo Excepcional (Pruebas de Hardware)</h6>
                                                </div>
                                                <form id="exceptionalCommandForm" class="exceptional-form">
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <label class="form-label">Componente</label>
                                                            <select class="form-select" id="exceptionalEvento" required>
                                                                {% for event in catcher_exceptional_events %}
                                                                <option value="{{ event }}">{{ event }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Duración (ms)</label>
                                                            <input type="number" class="form-control" id="exceptionalDuracion" min="500" step="100" value="3000" required>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Hora (opcional)</label>
                                                            <input type="number" class="form-control" id="exceptionalHora" min="0" value="0">
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                                        <small class="text-muted">Ideal para validar bombas y el servo de alimentación.</small>
                                                        <button type="submit" class="btn btn-gradient" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white;">
                                                            <i class="fas fa-paper-plane me-1"></i>Enviar prueba
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>

                                            <hr>
                                            <div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-clock text-cyan-600 me-2"></i>
                                                    <h6 class="mb-0 text-cyan-800">Bitácora rápida</h6>
                                                </div>
                                                <ul id="commandHistory" class="history-timeline"></ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="card sensor-card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    <h5 class="mb-1">Telemetría en vivo</h5>
                                                    <small>Última actualización: <span id="sensorUpdatedAt">--</span></small>
                                                </div>
                                                <span id="sistemaEstadoBadge" class="status-chip idle">
                                                    <i class="fas fa-circle"></i>Sin datos
                                                </span>
                                            </div>

                                            <div class="row g-3 mb-3">
                                                <div class="col-4">
                                                    <div class="text-center">
                                                        <p class="mb-1 text-uppercase small">Nivel (cm)</p>
                                                        <div id="nivelActual" class="sensor-metric">--</div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="text-center">
                                                        <p class="mb-1 text-uppercase small">TDS (ppm)</p>
                                                        <div id="tdsActual" class="sensor-metric">--</div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="text-center">
                                                        <p class="mb-1 text-uppercase small">Nivel (%)</p>
                                                        <div id="liquidoActual" class="sensor-metric">--</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <small class="text-uppercase">Bomba llenado</small>
                                                        <div id="bomba6Estado">--</div>
                                                    </div>
                                                    <div>
                                                        <small class="text-uppercase">Bomba vaciado</small>
                                                        <div id="bomba7Estado">--</div>
                                                    </div>
                                                    <div>
                                                        <small class="text-uppercase">Servo</small>
                                                        <div id="servoEstado">--</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="chart-wrapper">
                                                <canvas id="sensorTrendChart" height="160"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
                
        <script>
const COMMAND_ENDPOINT = '/api/catcher_command';
const COMMAND_LABELS = {
    AUTOMATICO: 'Modo Automático',
    VACIAR: 'Vaciar pecera',
    RELLENAR: 'Rellenar pecera',
    REINICIAR: 'Reiniciar sistema',
    CANCELAR: 'Cancelar eventos',
    EXCEPCIONAL: 'Modo Excepcional'
};
const EXCEPTIONAL_LABELS = {
    BOMBA6: 'Bomba llenado',
    BOMBA7: 'Bomba vaciado',
    SERVO: 'Servo alimento'
};
const STATUS_CLASS_MAP = {
    idle: 'status-chip idle',
    sending: 'status-chip sending',
    success: 'status-chip success',
    error: 'status-chip error'
};
let sensorTrendChart = null;
let commandHistory = [];

document.addEventListener('DOMContentLoaded', () => {
    initEstadoSwitches();
    initEditarAspersor();
    initEliminarAspersor();
    initCommandCenter();
    refreshRealtimePanel();
    loadSensorTrend();
    setInterval(refreshRealtimePanel, 5000);
    setInterval(loadSensorTrend, 15000);
});

function initEstadoSwitches() {
    document.querySelectorAll('.estado-switch').forEach((sw) => {
        sw.addEventListener('change', (event) => {
            const aspersorId = event.target.dataset.id;
            const nuevoEstado = event.target.checked ? 'activo' : 'inactivo';

            fetch('/actualizar_estado_aspersor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_aspersor: aspersorId, estado: nuevoEstado })
            }).then((response) => {
                if (!response.ok) {
                    event.target.checked = !event.target.checked;
                }
            }).catch(() => {
                event.target.checked = !event.target.checked;
            });
        });
    });
}

function initEditarAspersor() {
    document.querySelectorAll('.editar-aspersor').forEach((button) => {
        button.addEventListener('click', () => {
            document.getElementById('editarIdAspersor').value = button.dataset.id;
            document.getElementById('editarNombre').value = button.dataset.nombre;
            document.getElementById('editarUbicacion').value = button.dataset.ubicacion;
            document.getElementById('editarCameraUrl').value = button.dataset.cameraUrl || '';
        });
    });

    const formEditar = document.querySelector('form[action="/actualizar_aspersor"]');
    if (formEditar) {
        formEditar.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(formEditar);
            const payload = Object.fromEntries(formData.entries());

            fetch('/actualizar_aspersor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || 'Error al actualizar.');
                }
            }).catch((error) => console.error('Error:', error));
        });
    }
}

function initEliminarAspersor() {
    document.querySelectorAll('.eliminar-aspersor').forEach((button) => {
        button.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            if (!confirm('¿Estás seguro de eliminar esta pecera?')) {
                return;
            }
            fetch('/eliminar_aspersor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_aspersor: id })
            }).then((res) => res.json())
            .then((data) => {
                if (data.message) {
                    window.location.reload();
                } else {
                    alert(data.error || 'Error al eliminar.');
                }
            }).catch((err) => {
                console.error('Error en la solicitud:', err);
                alert('Error al eliminar el aspersor.');
            });
        });
    });
}

function initCommandCenter() {
    const buttons = document.querySelectorAll('[data-command]');
    const exceptionalForm = document.getElementById('exceptionalCommandForm');

    buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const tipo = btn.dataset.command;
            const payload = buildCommandPayload(tipo);
            sendCatcherCommand(payload);
        });
    });

    if (exceptionalForm) {
        exceptionalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const evento = document.getElementById('exceptionalEvento').value;
            const duracion = parseInt(document.getElementById('exceptionalDuracion').value, 10);
            const hora = parseInt(document.getElementById('exceptionalHora').value || '0', 10);

            const payload = {
                tipo: 'EXCEPCIONAL',
                evento,
                duracion: Number.isFinite(duracion) ? duracion : 0,
                hora: Number.isFinite(hora) ? hora : 0
            };
            sendCatcherCommand(payload);
        });
    }
}

function buildCommandPayload(tipo) {
    const payload = { tipo };
    if (tipo === 'RELLENAR') {
        const targetInput = document.getElementById('targetLevelInput');
        if (targetInput) {
            const objetivo = parseInt(targetInput.value, 10);
            if (!Number.isNaN(objetivo) && objetivo > 0) {
                payload.objetivo = objetivo;
            }
        }
    }
    return payload;
}

function sendCatcherCommand(payload) {
    if (!payload || !payload.tipo) {
        return;
    }

    const friendly = COMMAND_LABELS[payload.tipo] || payload.tipo;
    updateCommandStatus('sending', `Enviando ${friendly}...`);
    fetch(COMMAND_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then((response) => response.json())
    .then((data) => {
        if (data.success) {
            const message = data.message || 'Comando enviado correctamente';
            updateCommandStatus('success', message);
            appendCommandHistory(payload, true);
            showCommandToast(message, 'success');
        } else {
            const errorMsg = data.error || 'Error al enviar comando';
            updateCommandStatus('error', errorMsg);
            appendCommandHistory(payload, false);
            showCommandToast(errorMsg, 'danger');
        }
    }).catch((error) => {
        console.error('Error enviando comando:', error);
        updateCommandStatus('error', 'Sin conexión con MQTT');
        appendCommandHistory(payload, false);
        showCommandToast('No se pudo enviar el comando', 'danger');
    });
}

function updateCommandStatus(state, message) {
    const badge = document.getElementById('commandStatusBadge');
    if (!badge) {
        return;
    }
    badge.className = STATUS_CLASS_MAP[state] || STATUS_CLASS_MAP.idle;
    badge.innerHTML = `<i class="fas fa-circle"></i>&nbsp;${message}`;
}

function appendCommandHistory(payload, success) {
    const timestamp = new Date();
    const readable = COMMAND_LABELS[payload.tipo] || payload.tipo;
    let detail = readable;

    if (payload.tipo === 'EXCEPCIONAL') {
        const eventLabel = EXCEPTIONAL_LABELS[payload.evento] || payload.evento;
        detail = `${eventLabel} · ${payload.duracion} ms`;
    } else if (payload.tipo === 'RELLENAR' && payload.objetivo) {
        detail = `${readable} · Objetivo ${payload.objetivo} cm`;
    }

    commandHistory.unshift({ detail, success, timestamp });
    commandHistory = commandHistory.slice(0, 6);

    const historyList = document.getElementById('commandHistory');
    if (!historyList) {
        return;
    }
    historyList.innerHTML = '';
    commandHistory.forEach((entry) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${entry.detail}</span><small>${formatTimestamp(entry.timestamp)} · ${entry.success ? 'OK' : 'Fallo'}</small>`;
        historyList.appendChild(li);
    });
}

function showCommandToast(message, type = 'info') {
    const container = document.getElementById('commandToastContainer');
    if (!container) {
        return;
    }
    const wrapper = document.createElement('div');
    wrapper.className = `alert alert-${type} shadow`;
    wrapper.role = 'alert';
    wrapper.textContent = message;
    container.appendChild(wrapper);
    setTimeout(() => {
        wrapper.classList.add('fade');
        setTimeout(() => wrapper.remove(), 300);
    }, 2300);
}

function refreshRealtimePanel() {
    fetch('/get_latest_sensor_data')
        .then((res) => res.json())
        .then((data) => {
            const ultrasonico = data && data.ultrasonico ? data.ultrasonico : {};
            const tds = data && data.tds ? data.tds : {};
            const liquido = data && data.liquido ? data.liquido : {};
            updateSensorMetric('nivelActual', ultrasonico.distancia_cm, 'cm');
            updateSensorMetric('tdsActual', tds.ppm, 'ppm');
            updateSensorMetric('liquidoActual', liquido.nivel_pct, '%');
            updateSystemSnapshot(data && data.sistema);
            updateTimestamp(data && data.timestamp);
        })
        .catch((err) => console.error('Error actualizando telemetría:', err));
}

function updateSensorMetric(elementId, value, suffix) {
    const element = document.getElementById(elementId);
    if (!element) {
        return;
    }
    const numeric = Number(value);
    if (!Number.isFinite(numeric)) {
        element.textContent = '--';
        return;
    }
    const formatted = numeric.toFixed(1);
    element.textContent = suffix ? `${formatted} ${suffix}` : formatted;
}

function updateSystemSnapshot(sistema) {
    const estadoBadge = document.getElementById('sistemaEstadoBadge');
    const bomba6 = document.getElementById('bomba6Estado');
    const bomba7 = document.getElementById('bomba7Estado');
    const servo = document.getElementById('servoEstado');

    if (!sistema) {
        if (estadoBadge) {
            estadoBadge.className = STATUS_CLASS_MAP.idle;
            estadoBadge.innerHTML = '<i class="fas fa-circle"></i>Sin datos';
        }
        if (bomba6) bomba6.textContent = '--';
        if (bomba7) bomba7.textContent = '--';
        if (servo) servo.textContent = '--';
        return;
    }

    if (estadoBadge) {
        estadoBadge.className = STATUS_CLASS_MAP.success;
        const estadoTexto = sistema.estado && sistema.estado.trim() ? sistema.estado : 'Operativo';
        estadoBadge.innerHTML = `<i class="fas fa-circle"></i>&nbsp;${estadoTexto}`;
    }
    if (bomba6) bomba6.textContent = sistema.bomba6 !== undefined && sistema.bomba6 !== null ? sistema.bomba6 : '--';
    if (bomba7) bomba7.textContent = sistema.bomba7 !== undefined && sistema.bomba7 !== null ? sistema.bomba7 : '--';
    if (servo) servo.textContent = sistema.servo_pos !== undefined && sistema.servo_pos !== null ? sistema.servo_pos : '--';
}

function updateTimestamp(timestamp) {
    const label = document.getElementById('sensorUpdatedAt');
    if (!label) {
        return;
    }
    if (!timestamp) {
        label.textContent = '--';
        return;
    }
    label.textContent = formatTimestamp(timestamp);
}

function formatTimestamp(timestamp) {
    const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
    if (Number.isNaN(date.getTime())) {
        return '--';
    }
    return date.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function loadSensorTrend() {
    Promise.all([
        fetch('/sensor_data/ultrasonico?limit=12').then((res) => res.json()).catch(() => []),
        fetch('/sensor_data/calidad?limit=12').then((res) => res.json()).catch(() => [])
    ]).then(([nivel, tds]) => {
        const nivelData = Array.isArray(nivel) ? nivel.slice().reverse() : [];
        const tdsData = Array.isArray(tds) ? tds.slice().reverse() : [];
        const maxPoints = Math.max(nivelData.length, tdsData.length, 1);
        const labels = [];
        const nivelPoints = [];
        const tdsPoints = [];

        for (let i = 0; i < maxPoints; i += 1) {
            const nivelPoint = nivelData[i];
            const tdsPoint = tdsData[i];
            const labelSource = (nivelPoint && nivelPoint.timestamp) || (tdsPoint && tdsPoint.timestamp);
            labels.push(labelSource ? formatTimestamp(labelSource) : `Muestra ${i + 1}`);
            const nivelValor = nivelPoint ? (nivelPoint.distance_cm !== undefined ? nivelPoint.distance_cm : nivelPoint.valor) : null;
            nivelPoints.push(nivelValor !== undefined && nivelValor !== null ? Number(nivelValor) : null);
            const tdsValor = tdsPoint ? tdsPoint.valor : null;
            tdsPoints.push(tdsValor !== undefined && tdsValor !== null ? Number(tdsValor) : null);
        }

        renderSensorChart(labels, nivelPoints, tdsPoints);
    }).catch((err) => console.error('Error cargando gráfico:', err));
}

function renderSensorChart(labels, nivelData, tdsData) {
    const canvas = document.getElementById('sensorTrendChart');
    if (!canvas) {
        return;
    }
    const ctx = canvas.getContext('2d');
    const chartData = {
        labels,
        datasets: [
            {
                label: 'Nivel (cm)',
                data: nivelData,
                borderColor: '#f0fdfa',
                backgroundColor: 'rgba(255,255,255,0.2)',
                borderWidth: 3,
                lineTension: 0.25,
                pointRadius: 0
            },
            {
                label: 'TDS (ppm)',
                data: tdsData,
                borderColor: '#fcd34d',
                backgroundColor: 'rgba(252,211,77,0.2)',
                borderWidth: 3,
                lineTension: 0.25,
                pointRadius: 0
            }
        ]
    };

    const chartOptions = {
        maintainAspectRatio: false,
        legend: {
            labels: { fontColor: '#e0f2fe' }
        },
        scales: {
            xAxes: [{
                ticks: { fontColor: '#e0f2fe', maxTicksLimit: 6 },
                gridLines: { color: 'rgba(255,255,255,0.2)' }
            }],
            yAxes: [{
                ticks: { fontColor: '#e0f2fe', beginAtZero: true },
                gridLines: { color: 'rgba(255,255,255,0.2)' }
            }]
        }
    };

    if (!sensorTrendChart) {
        sensorTrendChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: chartOptions
        });
    } else {
        sensorTrendChart.data = chartData;
        sensorTrendChart.options = chartOptions;
        sensorTrendChart.update();
    }
}

    </script>

{% endblock %}