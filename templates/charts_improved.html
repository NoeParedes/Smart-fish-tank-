{% extends "base2.html" %}

{% block title %}Análisis de Sensores - AquaZen{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Encabezado oceánico dinámico -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="p-4 rounded-4 text-white position-relative overflow-hidden"
                 style="background: linear-gradient(135deg, #0c4a6e 0%, #0e7490 25%, #0891b2 50%, #06b6d4 75%, #67e8f9 100%);">
                <!-- Efectos de burbujas animadas -->
                <div class="position-absolute" style="top: 8%; left: 4%; width: 16px; height: 16px; background: rgba(255, 255, 255, 0.12); border-radius: 50%; animation: bubble 8s ease-in-out infinite;"></div>
                <div class="position-absolute" style="top: 65%; right: 6%; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.18); border-radius: 50%; animation: bubble 6s ease-in-out infinite 2s;"></div>
                <div class="position-absolute" style="bottom: 15%; left: 85%; width: 12px; height: 12px; background: rgba(255, 255, 255, 0.09); border-radius: 50%; animation: bubble 10s ease-in-out infinite 4s;"></div>
                
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <svg width="70" height="70" viewBox="0 0 120 120" fill="none">
                                    <circle cx="60" cy="60" r="50" fill="rgba(255, 255, 255, 0.1)" stroke="white" stroke-width="2"/>
                                    <!-- Gráfico animado -->
                                    <path d="M25 80 Q35 70 45 75 Q55 60 65 65 Q75 50 85 55 Q95 45 105 50" stroke="white" stroke-width="3" fill="none">
                                        <animate attributeName="stroke-dasharray" values="0 200;200 0;0 200" dur="4s" repeatCount="indefinite"/>
                                    </path>
                                    <circle cx="35" cy="72" r="3" fill="#fbbf24" opacity="0.9">
                                        <animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/>
                                    </circle>
                                    <circle cx="55" cy="62" r="3" fill="#10b981" opacity="0.9">
                                        <animate attributeName="opacity" values="0.5;1;0.5" dur="2.5s" repeatCount="indefinite"/>
                                    </circle>
                                    <circle cx="75" cy="52" r="3" fill="#ef4444" opacity="0.9">
                                        <animate attributeName="opacity" values="0.5;1;0.5" dur="3s" repeatCount="indefinite"/>
                                    </circle>
                                    <circle cx="95" cy="47" r="3" fill="#8b5cf6" opacity="0.9">
                                        <animate attributeName="opacity" values="0.5;1;0.5" dur="3.5s" repeatCount="indefinite"/>
                                    </circle>
                                </svg>
                            </div>
                            <div>
                                <h1 class="fw-bold mb-2" style="font-size: 2.5rem;">
                                    {% if sensor_type %}
                                        {% if sensor_type == 'temperatura' %}
                                            <i class="fas fa-thermometer-half me-2"></i>Análisis de Temperatura
                                        {% elif sensor_type == 'humedad' %}
                                            <i class="fas fa-tint me-2"></i>Análisis de Humedad
                                        {% elif sensor_type == 'ultrasonico' %}
                                            <i class="fas fa-ruler me-2"></i>Análisis de Nivel de Agua
                                        {% elif sensor_type == 'calidad' %}
                                            <i class="fas fa-water me-2"></i>Análisis de Calidad del Agua
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-chart-line me-2"></i>Panel de Análisis AquaZen
                                    {% endif %}
                                </h1>
                                <p class="fs-5 mb-0 opacity-90">
                                    {% if sensor_type %}
                                        Monitoreo especializado del sensor {{ sensor_type|title }} en tiempo real
                                    {% else %}
                                        Monitoreo integral de todos los sensores del ecosistema acuático
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 text-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <div class="me-4 text-center">
                                <i class="fas fa-chart-line fs-1 mb-2 d-block opacity-75"></i>
                                <small class="fw-semibold">Tiempo Real</small>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-brain fs-1 mb-2 d-block opacity-75"></i>
                                <small class="fw-semibold">IA Predictiva</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegación de sensores (solo si no hay sensor específico seleccionado) -->
    {% if not sensor_type %}
    <div class="row g-4 mb-5">
        <div class="col-12">
            <div class="card card-ocean" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-microscope me-2"></i>
                        Seleccionar Sensor para Análisis Detallado
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <a href="?sensor=temperatura" class="text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%); transition: all 0.3s ease;"
                                     onmouseover="this.style.transform='translateY(-5px) scale(1.02)'"
                                     onmouseout="this.style.transform='translateY(0) scale(1)'">
                                    <div class="card-body text-center p-4">
                                        <i class="fas fa-thermometer-half fa-3x text-orange-600 mb-3"></i>
                                        <h6 class="fw-bold text-orange-800">Temperatura</h6>
                                        <small class="text-orange-700">Sensor térmico acuático</small>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="?sensor=humedad" class="text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); transition: all 0.3s ease;"
                                     onmouseover="this.style.transform='translateY(-5px) scale(1.02)'"
                                     onmouseout="this.style.transform='translateY(0) scale(1)'">
                                    <div class="card-body text-center p-4">
                                        <i class="fas fa-tint fa-3x text-blue-600 mb-3"></i>
                                        <h6 class="fw-bold text-blue-800">Humedad</h6>
                                        <small class="text-blue-700">Humedad del sustrato</small>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="?sensor=ultrasonico" class="text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); transition: all 0.3s ease;"
                                     onmouseover="this.style.transform='translateY(-5px) scale(1.02)'"
                                     onmouseout="this.style.transform='translateY(0) scale(1)'">
                                    <div class="card-body text-center p-4">
                                        <i class="fas fa-ruler fa-3x text-green-600 mb-3"></i>
                                        <h6 class="fw-bold text-green-800">Nivel de Agua</h6>
                                        <small class="text-green-700">Sensor ultrasónico</small>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="?sensor=calidad" class="text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); transition: all 0.3s ease;"
                                     onmouseover="this.style.transform='translateY(-5px) scale(1.02)'"
                                     onmouseout="this.style.transform='translateY(0) scale(1)'">
                                    <div class="card-body text-center p-4">
                                        <i class="fas fa-water fa-3x text-pink-600 mb-3"></i>
                                        <h6 class="fw-bold text-pink-800">Calidad del Agua</h6>
                                        <small class="text-pink-700">Análisis de pureza</small>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Vista específica por sensor -->
    {% if sensor_type %}
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="text-teal-800 fw-bold mb-1">
                        {% if sensor_type == 'temperatura' %}
                            Monitor de Temperatura Acuática
                        {% elif sensor_type == 'humedad' %}
                            Monitor de Humedad del Sustrato
                        {% elif sensor_type == 'ultrasonico' %}
                            Monitor de Nivel de Agua
                        {% elif sensor_type == 'calidad' %}
                            Monitor de Calidad del Agua
                        {% endif %}
                    </h3>
                    <p class="text-teal-600 mb-0">Datos en tiempo real con análisis predictivo</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('charts') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>Volver al Panel General
                    </a>
                    <button class="btn btn-primary btn-sm" onclick="refreshChart()">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar Datos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas en tiempo real del sensor específico -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0" 
                 style="background: linear-gradient(135deg, 
                 {% if sensor_type == 'temperatura' %}#fef3c7 0%, #fed7aa 100%{% elif sensor_type == 'humedad' %}#dbeafe 0%, #bfdbfe 100%{% elif sensor_type == 'ultrasonico' %}#dcfce7 0%, #bbf7d0 100%{% elif sensor_type == 'calidad' %}#fce7f3 0%, #fbcfe8 100%{% endif %}); border-radius: 20px;">
                <div class="card-body text-center p-4">
                    <i class="fas 
                       {% if sensor_type == 'temperatura' %}fa-thermometer-half text-orange-600
                       {% elif sensor_type == 'humedad' %}fa-tint text-blue-600
                       {% elif sensor_type == 'ultrasonico' %}fa-ruler text-green-600
                       {% elif sensor_type == 'calidad' %}fa-water text-pink-600
                       {% endif %} fa-2x mb-3"></i>
                    <h4 class="fw-bold mb-1" id="currentValue">-- {{ 
                        'C°' if sensor_type == 'temperatura' else 
                        '%' if sensor_type == 'humedad' else 
                        'cm' if sensor_type == 'ultrasonico' else 
                        '' if sensor_type == 'calidad'
                    }}</h4>
                    <p class="mb-1 fw-semibold">Valor Actual</p>
                    <small class="opacity-75" id="lastUpdate">Actualizando...</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0" style="background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); border-radius: 20px;">
                <div class="card-body text-center p-4">
                    <i class="fas fa-arrow-trend-up text-teal-600 fa-2x mb-3"></i>
                    <h4 class="fw-bold mb-1 text-teal-800" id="avgValue">--</h4>
                    <p class="mb-1 fw-semibold text-teal-700">Promedio (24h)</p>
                    <small class="text-teal-600">Últimas mediciones</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0" style="background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%); border-radius: 20px;">
                <div class="card-body text-center p-4">
                    <i class="fas fa-chart-line text-green-600 fa-2x mb-3"></i>
                    <h4 class="fw-bold mb-1 text-green-800" id="trendValue">--</h4>
                    <p class="mb-1 fw-semibold text-green-700">Tendencia</p>
                    <small class="text-green-600">Últimas 6h</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-radius: 20px;">
                <div class="card-body text-center p-4">
                    <i class="fas fa-exclamation-triangle text-yellow-600 fa-2x mb-3"></i>
                    <h4 class="fw-bold mb-1 text-yellow-800" id="alertStatus">Normal</h4>
                    <p class="mb-1 fw-semibold text-yellow-700">Estado</p>
                    <small class="text-yellow-600">Sistema estable</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráficas principales -->
    <div class="row g-4">
        {% if sensor_type %}
        <!-- Vista específica del sensor -->
        <div class="col-12">
            <div class="card card-ocean" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header d-flex justify-content-between align-items-center" 
                     style="background: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <div>
                        <h5 class="mb-1 fw-bold">
                            Gráfica de {{ sensor_type|title }} en Tiempo Real
                        </h5>
                        <small class="opacity-90">Últimas 50 lecturas con análisis de tendencias</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-sm" onclick="toggleChartType()">
                            <i class="fas fa-chart-bar"></i> Cambiar Vista
                        </button>
                        <button class="btn btn-light btn-sm" onclick="downloadChart()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: 2rem;">
                    <div style="position: relative; height: 450px;">
                        <canvas id="sensorChart" style="max-height: 450px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas detalladas -->
        <div class="col-lg-6">
            <div class="card card-ocean h-100" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <h6 class="mb-0 fw-bold">Estadísticas del Sensor</h6>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);">
                                <h6 class="fw-bold text-teal-800 mb-1" id="maxValue">--</h6>
                                <small class="text-teal-600">Máximo</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);">
                                <h6 class="fw-bold text-teal-800 mb-1" id="minValue">--</h6>
                                <small class="text-teal-600">Mínimo</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);">
                                <h6 class="fw-bold text-green-800 mb-1" id="medianValue">--</h6>
                                <small class="text-green-600">Mediana</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Análisis de tendencias -->
        <div class="col-lg-6">
            <div class="card card-ocean h-100" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <h6 class="mb-0 fw-bold">Análisis de Tendencias</h6>
                </div>
                <div class="card-body p-4">
                    <div id="trendAnalysis" class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-chart-line fa-2x text-teal-600 mb-2"></i>
                            <h6 class="text-teal-800 fw-bold">Calculando tendencias...</h6>
                        </div>
                        <div class="progress" style="height: 6px; border-radius: 3px;">
                            <div class="progress-bar" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); width: 0%" id="analysisProgress"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Vista de resumen de todos los sensores -->
        <div class="col-lg-6">
            <div class="card card-ocean" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-thermometer-half me-2"></i>Temperatura del Agua
                    </h6>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <canvas id="temperatureChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card card-ocean" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-tint me-2"></i>Humedad del Sustrato
                    </h6>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <canvas id="humidityChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card card-ocean" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-ruler me-2"></i>Nivel de Agua
                    </h6>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <canvas id="distanceChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card card-ocean" style="border-radius: 20px; border: 2px solid #a7f3d0;">
                <div class="card-header" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; border: none; border-radius: 18px 18px 0 0; padding: 1.5rem;">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-water me-2"></i>Calidad del Agua
                    </h6>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <canvas id="qualityChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Variables globales
    let sensorChart = null;
    let temperatureChart = null;
    let humidityChart = null;
    let distanceChart = null;
    let qualityChart = null;
    const sensorType = '{{ sensor_type or "" }}';

    // Configuración común para gráficas
    const chartConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        size: 12,
                        weight: 'bold'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'white',
                bodyColor: 'white',
                borderColor: '#06b6d4',
                borderWidth: 1,
                cornerRadius: 10,
                displayColors: true
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                grid: {
                    color: 'rgba(6, 182, 212, 0.1)',
                    lineWidth: 1
                },
                ticks: {
                    color: '#0891b2',
                    font: {
                        size: 11,
                        weight: '500'
                    }
                }
            },
            x: {
                grid: {
                    color: 'rgba(6, 182, 212, 0.1)',
                    lineWidth: 1
                },
                ticks: {
                    color: '#0891b2',
                    font: {
                        size: 11,
                        weight: '500'
                    },
                    maxTicksLimit: 10
                }
            }
        },
        elements: {
            line: {
                tension: 0.4,
                borderWidth: 3
            },
            point: {
                radius: 4,
                hoverRadius: 8,
                borderWidth: 2
            }
        }
    };

    // Función para crear gradientes
    function createGradient(ctx, color1, color2) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, color1);
        gradient.addColorStop(1, color2);
        return gradient;
    }

    // Función para crear gráficas específicas por sensor
    function createSensorChart(sensorType) {
        if (!sensorType) return;

        const ctx = document.getElementById('sensorChart').getContext('2d');
        
        const colors = {
            temperatura: {
                bg: 'rgba(251, 191, 36, 0.1)',
                border: '#f59e0b',
                gradient1: 'rgba(251, 191, 36, 0.3)',
                gradient2: 'rgba(251, 191, 36, 0.05)'
            },
            humedad: {
                bg: 'rgba(59, 130, 246, 0.1)',
                border: '#3b82f6',
                gradient1: 'rgba(59, 130, 246, 0.3)',
                gradient2: 'rgba(59, 130, 246, 0.05)'
            },
            ultrasonico: {
                bg: 'rgba(34, 197, 94, 0.1)',
                border: '#22c55e',
                gradient1: 'rgba(34, 197, 94, 0.3)',
                gradient2: 'rgba(34, 197, 94, 0.05)'
            },
            calidad: {
                bg: 'rgba(236, 72, 153, 0.1)',
                border: '#ec4899',
                gradient1: 'rgba(236, 72, 153, 0.3)',
                gradient2: 'rgba(236, 72, 153, 0.05)'
            }
        };

        const config = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: sensorType.charAt(0).toUpperCase() + sensorType.slice(1),
                    data: [],
                    backgroundColor: createGradient(ctx, colors[sensorType].gradient1, colors[sensorType].gradient2),
                    borderColor: colors[sensorType].border,
                    fill: true,
                    pointBackgroundColor: colors[sensorType].border,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                ...chartConfig,
                plugins: {
                    ...chartConfig.plugins,
                    title: {
                        display: true,
                        text: `Tendencia de ${sensorType.charAt(0).toUpperCase() + sensorType.slice(1)}`,
                        color: '#0891b2',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: 20
                    }
                }
            }
        };

        sensorChart = new Chart(ctx, config);
        loadSensorData(sensorType);
    }

    // Función para crear gráficas del panel general
    function createGeneralCharts() {
        // Gráfica de temperatura
        const tempCtx = document.getElementById('temperatureChart').getContext('2d');
        temperatureChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperatura (°C)',
                    data: [],
                    backgroundColor: createGradient(tempCtx, 'rgba(251, 191, 36, 0.3)', 'rgba(251, 191, 36, 0.05)'),
                    borderColor: '#f59e0b',
                    fill: true
                }]
            },
            options: chartConfig
        });

        // Gráfica de humedad
        const humCtx = document.getElementById('humidityChart').getContext('2d');
        humidityChart = new Chart(humCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Humedad (%)',
                    data: [],
                    backgroundColor: createGradient(humCtx, 'rgba(59, 130, 246, 0.3)', 'rgba(59, 130, 246, 0.05)'),
                    borderColor: '#3b82f6',
                    fill: true
                }]
            },
            options: chartConfig
        });

        // Gráfica de distancia
        const distCtx = document.getElementById('distanceChart').getContext('2d');
        distanceChart = new Chart(distCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Nivel de Agua (cm)',
                    data: [],
                    backgroundColor: createGradient(distCtx, 'rgba(34, 197, 94, 0.3)', 'rgba(34, 197, 94, 0.05)'),
                    borderColor: '#22c55e',
                    fill: true
                }]
            },
            options: chartConfig
        });

        // Gráfica de calidad
        const qualCtx = document.getElementById('qualityChart').getContext('2d');
        qualityChart = new Chart(qualCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Calidad del Agua',
                    data: [],
                    backgroundColor: createGradient(qualCtx, 'rgba(236, 72, 153, 0.3)', 'rgba(236, 72, 153, 0.05)'),
                    borderColor: '#ec4899',
                    fill: true
                }]
            },
            options: chartConfig
        });

        loadGeneralData();
    }

    // Cargar datos específicos del sensor
    function loadSensorData(sensorType) {
        const endpoint = sensorType === 'temperatura' ? 'humedad' : 
                        sensorType === 'humedad' ? 'humedad' :
                        sensorType === 'ultrasonico' ? 'humedad' :
                        'humedad';
        
        fetch(`/sensor_data/${endpoint}?limit=50`)
            .then(response => response.json())
            .then(data => {
                if (sensorChart && data.length > 0) {
                    const labels = data.map(item => new Date(item.timestamp).toLocaleTimeString());
                    const values = data.map(item => parseFloat(item.valor || item.distance_cm || item.humedad || 0));
                    
                    sensorChart.data.labels = labels;
                    sensorChart.data.datasets[0].data = values;
                    sensorChart.update();
                    
                    updateSensorStats(values);
                }
            })
            .catch(error => console.error('Error loading sensor data:', error));
    }

    // Cargar datos para el panel general
    function loadGeneralData() {
        fetch('/sensor_data/humedad?limit=20')
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const labels = data.map(item => new Date(item.timestamp).toLocaleTimeString());
                    const tempValues = data.map(item => parseFloat(item.humedad || 0));
                    
                    // Actualizar todas las gráficas
                    if (temperatureChart) {
                        temperatureChart.data.labels = labels;
                        temperatureChart.data.datasets[0].data = tempValues;
                        temperatureChart.update();
                    }
                    
                    if (humidityChart) {
                        humidityChart.data.labels = labels;
                        humidityChart.data.datasets[0].data = tempValues;
                        humidityChart.update();
                    }
                    
                    if (distanceChart) {
                        distanceChart.data.labels = labels;
                        distanceChart.data.datasets[0].data = tempValues;
                        distanceChart.update();
                    }
                    
                    if (qualityChart) {
                        qualityChart.data.labels = labels;
                        qualityChart.data.datasets[0].data = tempValues;
                        qualityChart.update();
                    }
                }
            })
            .catch(error => console.error('Error loading general data:', error));
    }

    // Actualizar estadísticas del sensor
    function updateSensorStats(values) {
        if (!values || values.length === 0) return;
        
        const current = values[values.length - 1];
        const max = Math.max(...values);
        const min = Math.min(...values);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        const median = values.sort()[Math.floor(values.length / 2)];
        
        // Actualizar elementos del DOM
        const currentEl = document.getElementById('currentValue');
        if (currentEl) currentEl.textContent = current.toFixed(1) + (sensorType === 'temperatura' ? '°C' : sensorType === 'humedad' ? '%' : sensorType === 'ultrasonico' ? ' cm' : '');
        
        const avgEl = document.getElementById('avgValue');
        if (avgEl) avgEl.textContent = avg.toFixed(1);
        
        const maxEl = document.getElementById('maxValue');
        if (maxEl) maxEl.textContent = max.toFixed(1);
        
        const minEl = document.getElementById('minValue');
        if (minEl) minEl.textContent = min.toFixed(1);
        
        const medianEl = document.getElementById('medianValue');
        if (medianEl) medianEl.textContent = median.toFixed(1);
        
        // Actualizar tendencia
        const trend = values.length > 1 ? (values[values.length - 1] - values[0]) / values.length : 0;
        const trendEl = document.getElementById('trendValue');
        if (trendEl) {
            const trendText = trend > 0 ? '↗ Subiendo' : trend < 0 ? '↘ Bajando' : '→ Estable';
            trendEl.textContent = trendText;
        }
        
        // Simular progreso del análisis
        let progress = 0;
        const progressEl = document.getElementById('analysisProgress');
        const interval = setInterval(() => {
            progress += 10;
            if (progressEl) progressEl.style.width = progress + '%';
            if (progress >= 100) {
                clearInterval(interval);
                updateTrendAnalysis(trend);
            }
        }, 100);
    }

    // Actualizar análisis de tendencias
    function updateTrendAnalysis(trend) {
        const analysisEl = document.getElementById('trendAnalysis');
        if (!analysisEl) return;
        
        let trendIcon, trendColor, trendText, trendDescription;
        
        if (trend > 0.5) {
            trendIcon = 'fa-arrow-trend-up';
            trendColor = 'text-green-600';
            trendText = 'Tendencia Ascendente';
            trendDescription = 'Los valores muestran un incremento constante en las últimas horas.';
        } else if (trend < -0.5) {
            trendIcon = 'fa-arrow-trend-down';
            trendColor = 'text-red-600';
            trendText = 'Tendencia Descendente';
            trendDescription = 'Los valores muestran una disminución en las últimas horas.';
        } else {
            trendIcon = 'fa-arrows-left-right';
            trendColor = 'text-blue-600';
            trendText = 'Tendencia Estable';
            trendDescription = 'Los valores se mantienen relativamente constantes.';
        }
        
        analysisEl.innerHTML = `
            <div class="mb-3">
                <i class="fas ${trendIcon} fa-2x ${trendColor} mb-2"></i>
                <h6 class="${trendColor.replace('600', '800')} fw-bold">${trendText}</h6>
                <p class="small ${trendColor.replace('600', '700')} mb-0">${trendDescription}</p>
            </div>
        `;
    }

    // Funciones de utilidad
    function refreshChart() {
        if (sensorType) {
            loadSensorData(sensorType);
        } else {
            loadGeneralData();
        }
    }

    function toggleChartType() {
        if (sensorChart) {
            sensorChart.config.type = sensorChart.config.type === 'line' ? 'bar' : 'line';
            sensorChart.update();
        }
    }

    function downloadChart() {
        if (sensorChart) {
            const link = document.createElement('a');
            link.download = `sensor_${sensorType}_${new Date().getTime()}.png`;
            link.href = sensorChart.toBase64Image();
            link.click();
        }
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        if (sensorType) {
            createSensorChart(sensorType);
        } else {
            createGeneralCharts();
        }
        
        // Actualizar datos cada 30 segundos
        setInterval(() => {
            refreshChart();
        }, 30000);
    });
</script>

<style>
    @keyframes bubble {
        0% {
            transform: translateY(20px) scale(0);
            opacity: 0;
        }
        50% {
            opacity: 1;
        }
        100% {
            transform: translateY(-15px) scale(1);
            opacity: 0;
        }
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(14, 116, 144, 0.15) !important;
    }
    
    .progress-bar {
        transition: width 0.3s ease;
    }
    
    canvas {
        border-radius: 10px;
    }
</style>
{% endblock %}